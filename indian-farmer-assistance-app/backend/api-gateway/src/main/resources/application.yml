# API Gateway Configuration
# Environment: ${SPRING_PROFILES_ACTIVE:dev}

server:
  port: ${GATEWAY_SERVICE_PORT:8080}
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain,application/javascript,text/css
    min-response-size: 1024

spring:
  application:
    name: api-gateway
  config:
    import: optional:file:./config.yaml
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}
  main:
    web-application-type: reactive
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration
      - org.springframework.boot.autoconfigure.data.mongo.MongoDataAutoConfiguration
  data:
    redis:
      host: ${GATEWAY_REDIS_HOST:localhost}
      port: ${GATEWAY_REDIS_PORT:6379}
      password: ${GATEWAY_REDIS_PASSWORD:}
      timeout: 5000ms
      lettuce:
        pool:
          max-active: 20
          max-idle: 10
          min-idle: 5
          max-wait: 3000ms
  cloud:
    gateway:
      httpclient:
        connect-timeout: 5000
        response-timeout: 30s
      httpserver:
        wiretap: true
      routes:
        # Swagger/OpenAPI routes - no authentication required
        - id: swagger-ui
          uri: http://localhost:8080
          predicates:
            - Path=/swagger-ui.html,/swagger-ui/**,/v3/api-docs,/v3/api-docs/**,/swagger-resources,/swagger-resources/**,/webjars/**
          filters:
            - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_UNIQUE
        - id: user-service-swagger
          uri: lb://user-service
          predicates:
            - Path=/user-service/swagger-ui.html,/user-service/swagger-ui/**,/user-service/v3/api-docs,/user-service/v3/api-docs/**
          filters:
            - RewritePath=/user-service/(?<segment>.*), /$\{segment}
        - id: weather-service-swagger
          uri: lb://weather-service
          predicates:
            - Path=/weather-service/swagger-ui.html,/weather-service/swagger-ui/**,/weather-service/v3/api-docs,/weather-service/v3/api-docs/**
          filters:
            - RewritePath=/weather-service/(?<segment>.*), /$\{segment}
        - id: crop-service-swagger
          uri: lb://crop-service
          predicates:
            - Path=/crop-service/swagger-ui.html,/crop-service/swagger-ui/**,/crop-service/v3/api-docs,/crop-service/v3/api-docs/**
          filters:
            - RewritePath=/crop-service/(?<segment>.*), /$\{segment}
        - id: scheme-service-swagger
          uri: lb://scheme-service
          predicates:
            - Path=/scheme-service/swagger-ui.html,/scheme-service/swagger-ui/**,/scheme-service/v3/api-docs,/scheme-service/v3/api-docs/**
          filters:
            - RewritePath=/scheme-service/(?<segment>.*), /$\{segment}
        - id: mandi-service-swagger
          uri: lb://mandi-service
          predicates:
            - Path=/mandi-service/swagger-ui.html,/mandi-service/swagger-ui/**,/mandi-service/v3/api-docs,/mandi-service/v3/api-docs/**
          filters:
            - RewritePath=/mandi-service/(?<segment>.*), /$\{segment}
        - id: location-service-swagger
          uri: lb://location-service
          predicates:
            - Path=/location-service/swagger-ui.html,/location-service/swagger-ui/**,/location-service/v3/api-docs,/location-service/v3/api-docs/**
          filters:
            - RewritePath=/location-service/(?<segment>.*), /$\{segment}
        - id: admin-service-swagger
          uri: lb://admin-service
          predicates:
            - Path=/admin-service/swagger-ui.html,/admin-service/swagger-ui/**,/admin-service/v3/api-docs,/admin-service/v3/api-docs/**
          filters:
            - RewritePath=/admin-service/(?<segment>.*), /$\{segment}
        - id: iot-service-swagger
          uri: lb://iot-service
          predicates:
            - Path=/iot-service/swagger-ui.html,/iot-service/swagger-ui/**,/iot-service/v3/api-docs,/iot-service/v3/api-docs/**
          filters:
            - RewritePath=/iot-service/(?<segment>.*), /$\{segment}
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/api/v1/users/**
          filters:
            - AuthenticationFilter
            - AuthorizationFilter
            - RateLimitingFilter
            - RequestResponseTransformationFilter
            - RewritePath=/api/v1/users/(?<segment>.*), /$\{segment}
            - name: CircuitBreaker
              args:
                name: usersCircuitBreaker
                fallbackUri: forward:/fallback/users
            - name: Retry
              args:
                retries: 3
        - id: weather-service
          uri: lb://weather-service
          predicates:
            - Path=/api/v1/weather/**
          filters:
            - AuthenticationFilter
            - AuthorizationFilter
            - RateLimitingFilter
            - RequestResponseTransformationFilter
            - RewritePath=/api/v1/weather/(?<segment>.*), /$\{segment}
            - name: CircuitBreaker
              args:
                name: weatherCircuitBreaker
                fallbackUri: forward:/fallback/weather
            - name: Retry
              args:
                retries: 3
        - id: crop-service
          uri: lb://crop-service
          predicates:
            - Path=/api/v1/crops/**
          filters:
            - AuthenticationFilter
            - AuthorizationFilter
            - RateLimitingFilter
            - RequestResponseTransformationFilter
            - RewritePath=/api/v1/crops/(?<segment>.*), /$\{segment}
            - name: CircuitBreaker
              args:
                name: cropCircuitBreaker
                fallbackUri: forward:/fallback/crops
            - name: Retry
              args:
                retries: 3
        - id: scheme-service
          uri: lb://scheme-service
          predicates:
            - Path=/api/v1/schemes/**
          filters:
            - AuthenticationFilter
            - AuthorizationFilter
            - RateLimitingFilter
            - RequestResponseTransformationFilter
            - RewritePath=/api/v1/schemes/(?<segment>.*), /$\{segment}
            - name: CircuitBreaker
              args:
                name: schemeCircuitBreaker
                fallbackUri: forward:/fallback/schemes
            - name: Retry
              args:
                retries: 3
        - id: mandi-service
          uri: lb://mandi-service
          predicates:
            - Path=/api/v1/mandi/**
          filters:
            - AuthenticationFilter
            - AuthorizationFilter
            - RateLimitingFilter
            - RequestResponseTransformationFilter
            - RewritePath=/api/v1/mandi/(?<segment>.*), /$\{segment}
            - name: CircuitBreaker
              args:
                name: mandiCircuitBreaker
                fallbackUri: forward:/fallback/mandi
            - name: Retry
              args:
                retries: 3
        - id: iot-service
          uri: lb://iot-service
          predicates:
            - Path=/api/v1/iot/**
          filters:
            - AuthenticationFilter
            - AuthorizationFilter
            - RateLimitingFilter
            - RequestResponseTransformationFilter
            - RewritePath=/api/v1/iot/(?<segment>.*), /$\{segment}
            - name: CircuitBreaker
              args:
                name: iotCircuitBreaker
                fallbackUri: forward:/fallback/iot
            - name: Retry
              args:
                retries: 3
        - id: admin-service
          uri: lb://admin-service
          predicates:
            - Path=/api/v1/admin/**
          filters:
            - AuthenticationFilter
            - AuthorizationFilter
            - RateLimitingFilter
            - RequestResponseTransformationFilter
            - RewritePath=/api/v1/admin/(?<segment>.*), /$\{segment}
            - name: CircuitBreaker
              args:
                name: adminCircuitBreaker
                fallbackUri: forward:/fallback/admin
            - name: Retry
              args:
                retries: 3
        - id: ai-service
          uri: lb://ai-service
          predicates:
            - Path=/api/v1/ai/**
          filters:
            - AuthenticationFilter
            - AuthorizationFilter
            - RateLimitingFilter
            - RequestResponseTransformationFilter
            - RewritePath=/api/v1/ai/(?<segment>.*), /$\{segment}
            - name: CircuitBreaker
              args:
                name: aiCircuitBreaker
                fallbackUri: forward:/fallback/ai
            - name: Retry
              args:
                retries: 3
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_UNIQUE
        - AddRequestHeader=X-Forwarded-Proto, ${scheme:http}
        - AddResponseHeader=X-Response-Time, ${executionTime:}
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origins: ${CORS_ALLOWED_ORIGINS:http://localhost:4200,http://localhost:3000}
            allowed-methods: GET,POST,PUT,DELETE,OPTIONS
            allowed-headers: "*"
            allow-credentials: true
            max-age: 3600

eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_SERVER_URL:http://localhost:8761/eureka/}
    register-with-eureka: true
    fetch-registry: true
  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${server.port}

# Resilience4j Circuit Breaker Configuration
resilience4j:
  circuitbreaker:
    instances:
      usersCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 30s
        failureRateThreshold: 50
      weatherCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 30s
        failureRateThreshold: 50
      cropCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 30s
        failureRateThreshold: 50
      schemeCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 30s
        failureRateThreshold: 50
      mandiCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 30s
        failureRateThreshold: 50
      iotCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 30s
        failureRateThreshold: 50
      adminCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 30s
        failureRateThreshold: 50
      aiCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 60s
        failureRateThreshold: 50
  retry:
    instances:
      usersCircuitBreaker:
        maxAttempts: 3
        waitDuration: 500ms
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
      weatherCircuitBreaker:
        maxAttempts: 3
        waitDuration: 1000ms
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
      cropCircuitBreaker:
        maxAttempts: 3
        waitDuration: 500ms
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
      schemeCircuitBreaker:
        maxAttempts: 3
        waitDuration: 500ms
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
      mandiCircuitBreaker:
        maxAttempts: 3
        waitDuration: 500ms
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
      iotCircuitBreaker:
        maxAttempts: 3
        waitDuration: 500ms
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
      adminCircuitBreaker:
        maxAttempts: 3
        waitDuration: 500ms
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
      aiCircuitBreaker:
        maxAttempts: 3
        waitDuration: 1000ms
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
  ratelimiter:
    instances:
      apiRateLimiter:
        limitForPeriod: 100
        limitRefreshPeriod: 1s
        timeoutDuration: 500ms

# Actuator Configuration
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,circuitbreakers
  endpoint:
    health:
      show-details: always
  health:
    mongo:
      enabled: false
  metrics:
    tags:
      application: ${spring.application.name}

# Logging Configuration
logging:
  level:
    root: INFO
    com.farmer: DEBUG
    org.springframework.cloud.gateway: INFO
    org.springframework.data.redis: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

# JWT Configuration
jwt:
  secret: ${GATEWAY_JWT_SECRET:your-secret-key-change-in-production-with-at-least-32-characters}
  expiration: ${JWT_EXPIRATION:86400000}

# Swagger/OpenAPI Configuration
springdoc:
  api-docs:
    path: /v3/api-docs
    enabled: true
  swagger-ui:
    path: /swagger-ui.html
    enabled: true
    operations-sorter: method
    tags-sorter: alpha
    display-request-duration: true
    show-common-extensions: true
    doc-expansion: list
    deep-linking: true
    presets:
      - swaggerPresets.apis
      - SwaggerUIBundle.presets.layouts
    layout: StandaloneLayout
  show-actuator: true
  use-fqn: true
  cache:
    disabled: false

