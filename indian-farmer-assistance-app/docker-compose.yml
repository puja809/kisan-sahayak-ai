version: '3.8'

services:
  # ==================== BACKEND SERVICES ====================

  # Eureka Server (Service Registry)
  eureka-server:
    build:
      context: ./backend
      dockerfile: eureka-server/Dockerfile
    container_name: farmer-eureka-server
    ports:
      - "${EUREKA_SERVER_PORT:-8761}:8761"
    networks:
      - farmer-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8761/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # API Gateway (Entry point)
  api-gateway:
    build:
      context: ./backend
      dockerfile: api-gateway/Dockerfile
    container_name: farmer-api-gateway
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: ${DB_URL:-jdbc:postgresql://<gcp-postgres-ip>:5432/farmer_db}
      SPRING_DATASOURCE_USERNAME: ${DB_USER:-farmer}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-farmer_password}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_SERVER_URL:-http://eureka-server:8761/eureka/}
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
    ports:
      - "${GATEWAY_SERVICE_PORT:-8080}:8080"
    networks:
      - farmer-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - eureka-server

  # User Service
  user-service:
    build:
      context: ./backend
      dockerfile: user-service/Dockerfile
    container_name: farmer-user-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: ${USER_DB_URL:-jdbc:postgresql://<gcp-postgres-ip>:5432/farmer_db}
      SPRING_DATASOURCE_USERNAME: ${USER_DB_USERNAME:-farmer}
      SPRING_DATASOURCE_PASSWORD: ${USER_DB_PASSWORD:-farmer_password}
      USER_DB_URL: ${USER_DB_URL:-jdbc:postgresql://<gcp-postgres-ip>:5432/farmer_db}
      USER_DB_USERNAME: ${USER_DB_USERNAME:-farmer}
      USER_DB_PASSWORD: ${USER_DB_PASSWORD:-farmer_password}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_SERVER_URL:-http://eureka-server:8761/eureka/}
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-86400000}
      JWT_REFRESH_EXPIRATION: ${JWT_REFRESH_EXPIRATION:-604800000}
      JWT_ISSUER: ${JWT_ISSUER:-indian-farmer-assistance}
      USER_AGRISTACK_API_KEY: ${USER_AGRISTACK_API_KEY:-}
      AGRISTACK_BASE_URL: ${AGRISTACK_BASE_URL:-https://api.agristack.gov.in}
    ports:
      - "${USER_SERVICE_PORT:-8099}:8099"
    networks:
      - farmer-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8099/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - eureka-server

  # Crop Service
  crop-service:
    build:
      context: ./backend
      dockerfile: crop-service/Dockerfile
    container_name: farmer-crop-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: ${CROP_DB_URL:-jdbc:postgresql://<gcp-postgres-ip>:5432/farmer_db}
      SPRING_DATASOURCE_USERNAME: ${CROP_DB_USERNAME:-farmer}
      SPRING_DATASOURCE_PASSWORD: ${CROP_DB_PASSWORD:-farmer_password}
      CROP_DB_URL: ${CROP_DB_URL:-jdbc:postgresql://<gcp-postgres-ip>:5432/farmer_db}
      CROP_DB_USERNAME: ${CROP_DB_USERNAME:-farmer}
      CROP_DB_PASSWORD: ${CROP_DB_PASSWORD:-farmer_password}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_SERVER_URL:-http://eureka-server:8761/eureka/}
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
      ML_SERVICE_URL: ${ML_SERVICE_URL:-http://ml-service:8001}
      WEATHER_API_KEY: ${WEATHER_API_KEY:-}
      WEATHER_API_URL: ${WEATHER_API_URL:-https://api.weatherapi.com/v1}
      KAEGRO_API_KEY: ${KAEGRO_API_KEY:-}
    ports:
      - "${CROP_SERVICE_PORT:-8096}:8096"
    depends_on:
      - ml-service
      - eureka-server
    networks:
      - farmer-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8096/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Location Service
  location-service:
    build:
      context: ./backend
      dockerfile: location-service/Dockerfile
    container_name: farmer-location-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: ${LOCATION_DB_URL:-jdbc:postgresql://<gcp-postgres-ip>:5432/farmer_db}
      SPRING_DATASOURCE_USERNAME: ${LOCATION_DB_USERNAME:-farmer}
      SPRING_DATASOURCE_PASSWORD: ${LOCATION_DB_PASSWORD:-farmer_password}
      LOCATION_DB_URL: ${LOCATION_DB_URL:-jdbc:postgresql://<gcp-postgres-ip>:5432/farmer_db}
      LOCATION_DB_USERNAME: ${LOCATION_DB_USERNAME:-farmer}
      LOCATION_DB_PASSWORD: ${LOCATION_DB_PASSWORD:-farmer_password}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_SERVER_URL:-http://eureka-server:8761/eureka/}
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-86400000}
    ports:
      - "${LOCATION_SERVICE_PORT:-8095}:8095"
    networks:
      - farmer-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8095/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - eureka-server

  # Mandi Service
  mandi-service:
    build:
      context: ./backend
      dockerfile: mandi-service/Dockerfile
    container_name: farmer-mandi-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: ${MANDI_DB_URL:-jdbc:postgresql://<gcp-postgres-ip>:5432/farmer_db}
      SPRING_DATASOURCE_USERNAME: ${MANDI_DB_USERNAME:-farmer}
      SPRING_DATASOURCE_PASSWORD: ${MANDI_DB_PASSWORD:-farmer_password}
      MANDI_DB_URL: ${MANDI_DB_URL:-jdbc:postgresql://<gcp-postgres-ip>:5432/farmer_db}
      MANDI_DB_USERNAME: ${MANDI_DB_USERNAME:-farmer}
      MANDI_DB_PASSWORD: ${MANDI_DB_PASSWORD:-farmer_password}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_SERVER_URL:-http://eureka-server:8761/eureka/}
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
      ML_SERVICE_URL: ${ML_SERVICE_URL:-http://ml-service:8001}
      WEATHER_API_KEY: ${WEATHER_API_KEY:-}
      WEATHER_API_URL: ${WEATHER_API_URL:-https://api.weatherapi.com/v1}
      MANDI_DATAGOV_PRICE_API_KEY: ${MANDI_DATAGOV_PRICE_API_KEY:-}
      MANDI_DATAGOV_PRICE_API_URL: ${MANDI_DATAGOV_PRICE_API_URL:-https://api.data.gov.in/resource/9ef84268-d588-465a-a308-a864a43d0070}
      MANDI_DATAGOV_FERTILIZER_API_KEY: ${MANDI_DATAGOV_FERTILIZER_API_KEY:-}
      MANDI_DATAGOV_FERTILIZER_API_URL: ${MANDI_DATAGOV_FERTILIZER_API_URL:-https://api.data.gov.in/resource/56f40018-fd03-4010-94a3-f34ca7b43f7c}
    ports:
      - "${MANDI_SERVICE_PORT:-8093}:8093"
    networks:
      - farmer-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8093/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - eureka-server

  # Scheme Service
  scheme-service:
    build:
      context: ./backend
      dockerfile: scheme-service/Dockerfile
    container_name: farmer-scheme-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: ${SCHEME_DB_URL:-jdbc:postgresql://<gcp-postgres-ip>:5432/farmer_db}
      SPRING_DATASOURCE_USERNAME: ${SCHEME_DB_USERNAME:-farmer}
      SPRING_DATASOURCE_PASSWORD: ${SCHEME_DB_PASSWORD:-farmer_password}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_SERVER_URL:-http://eureka-server:8761/eureka/}
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
    ports:
      - "${SCHEME_SERVICE_PORT:-8097}:8097"
    networks:
      - farmer-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8097/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - eureka-server

  # Admin Service
  admin-service:
    build:
      context: ./backend
      dockerfile: admin-service/Dockerfile
    container_name: farmer-admin-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: ${ADMIN_DB_URL:-jdbc:postgresql://<gcp-postgres-ip>:5432/farmer_db}
      SPRING_DATASOURCE_USERNAME: ${ADMIN_DB_USERNAME:-farmer}
      SPRING_DATASOURCE_PASSWORD: ${ADMIN_DB_PASSWORD:-farmer_password}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_SERVER_URL:-http://eureka-server:8761/eureka/}
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
    ports:
      - "${ADMIN_SERVICE_PORT:-8091}:8091"
    networks:
      - farmer-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8091/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - eureka-server

  # IoT Service
  iot-service:
    build:
      context: ./backend
      dockerfile: iot-service/Dockerfile
    container_name: farmer-iot-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: ${IOT_DB_URL:-jdbc:postgresql://<gcp-postgres-ip>:5432/farmer_db}
      SPRING_DATASOURCE_USERNAME: ${IOT_DB_USERNAME:-farmer}
      SPRING_DATASOURCE_PASSWORD: ${IOT_DB_PASSWORD:-farmer_password}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_SERVER_URL:-http://eureka-server:8761/eureka/}
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
    ports:
      - "${IOT_SERVICE_PORT:-8094}:8094"
    networks:
      - farmer-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8094/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - eureka-server

  # Weather Service
  weather-service:
    build:
      context: ./backend
      dockerfile: weather-service/Dockerfile
    container_name: farmer-weather-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: ${WEATHER_DB_URL:-jdbc:postgresql://<gcp-postgres-ip>:5432/farmer_db}
      SPRING_DATASOURCE_USERNAME: ${WEATHER_DB_USERNAME:-farmer}
      SPRING_DATASOURCE_PASSWORD: ${WEATHER_DB_PASSWORD:-farmer_password}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_SERVER_URL:-http://eureka-server:8761/eureka/}
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
    ports:
      - "${WEATHER_SERVICE_PORT:-8092}:8092"
    networks:
      - farmer-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8092/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - eureka-server

  # Yield Service
  yield-service:
    build:
      context: ./backend
      dockerfile: yield-service/Dockerfile
    container_name: farmer-yield-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: ${YIELD_DB_URL:-jdbc:postgresql://<gcp-postgres-ip>:5432/farmer_db}
      SPRING_DATASOURCE_USERNAME: ${YIELD_DB_USERNAME:-farmer}
      SPRING_DATASOURCE_PASSWORD: ${YIELD_DB_PASSWORD:-farmer_password}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_SERVER_URL:-http://eureka-server:8761/eureka/}
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
    ports:
      - "${YIELD_SERVICE_PORT:-8098}:8098"
    networks:
      - farmer-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8098/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - eureka-server
  # ==================== ML SERVICE ====================
  ml-service:
    build:
      context: ./backend/ai-service
      dockerfile: Dockerfile.ml
    container_name: farmer-ml-service
    environment:
      PYTHONUNBUFFERED: 1
      EUREKA_SERVER_URL: ${EUREKA_SERVER_URL:-http://eureka-server:8761/eureka/}
      INSTANCE_HOST: ml-service
    ports:
      - "8001:8001"
    volumes:
      - ./backend/ai-service/app/models:/app/app/models
    networks:
      - farmer-network
    healthcheck:
      test: [ "CMD", "python", "-c", "import requests; requests.get('http://localhost:8001/health')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - eureka-server

  # ==================== FRONTEND ====================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: farmer-frontend
    environment:
      API_URL: ${API_URL:-http://localhost:8080}
    ports:
      - "80:4200"
    depends_on:
      - api-gateway
    networks:
      - farmer-network
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4200/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  farmer-network:
    driver: bridge
